{
  "name": "Planity â†’ Notion | Upsert RDV + DÃ©tection Annulations (JSON)",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-manual",
      "name": "ğŸŸ¢ DÃ©clencher manuellement",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 300]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// COLLE TON JSON ICI â€” objet complet exportÃ© par Planity\n// Format attendu :\n// {\n//   \"extraction_date\": \"2026-03-02\",\n//   \"semaine\": \"2026-W10\",\n//   \"etablissement\": \"Centre Laser Borderouge\",\n//   \"rendez_vous\": [\n//     {\n//       \"id_unique\": \"2026-03-02_11h30_Mathilde_Lena Cayssac\",\n//       \"date\": \"2026-03-02\",\n//       \"heure_debut\": \"11:30\",\n//       \"heure_fin\": \"12:55\",\n//       \"duree_minutes\": 85,\n//       \"collaboratrice\": \"Mathilde\",\n//       \"client_nom\": \"Lena Cayssac\",\n//       \"client_telephone\": \"07 81 14 58 05\",\n//       \"prestation\": \"SÃ©ance Laser Jambes EntiÃ¨res\",\n//       \"prix_estime\": 311,\n//       \"statut\": \"confirmÃ©\"\n//     }\n//   ]\n// }\n// ============================================================\n\nconst data = {\n  // â†“â†“â†“ REMPLACE CET OBJET PAR TON JSON â†“â†“â†“\n  \"extraction_date\": \"2026-03-02\",\n  \"semaine\": \"2026-W10\",\n  \"etablissement\": \"Centre Laser Borderouge\",\n  \"rendez_vous\": [\n    {\n      \"id_unique\": \"2026-03-02_11h30_Mathilde_Lena Cayssac\",\n      \"date\": \"2026-03-02\",\n      \"heure_debut\": \"11:30\",\n      \"heure_fin\": \"12:55\",\n      \"duree_minutes\": 85,\n      \"collaboratrice\": \"Mathilde\",\n      \"client_nom\": \"Lena Cayssac\",\n      \"client_telephone\": \"07 81 14 58 05\",\n      \"prestation\": \"SÃ©ance Laser Jambes EntiÃ¨res\",\n      \"prix_estime\": 311,\n      \"statut\": \"confirmÃ©\"\n    }\n  ]\n  // â†‘â†‘â†‘ FIN DE TON JSON â†‘â†‘â†‘\n};\n\n// Supporte les deux formats : objet avec rendez_vous OU tableau direct\nconst rdvs = Array.isArray(data) ? data : (data.rendez_vous || []);\nreturn rdvs.map(row => ({ json: row }));"
      },
      "id": "read-json",
      "name": "ğŸ“‹ DonnÃ©es RDV (JSON)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300]
    },
    {
      "parameters": {
        "jsCode": "// Normalise les champs et s'assure que les valeurs nulles sont gÃ©rÃ©es\nconst items = [];\n\nfor (const item of $input.all()) {\n  const row = item.json;\n  items.push({\n    json: {\n      id_unique: (row.id_unique || '').trim(),\n      date: (row.date || '').trim(),\n      heure_debut: (row.heure_debut || '').trim(),\n      heure_fin: (row.heure_fin || '').trim(),\n      duree_minutes: parseInt(row.duree_minutes) || 0,\n      client_nom: row.client_nom ? String(row.client_nom).trim() : 'Sans client',\n      client_telephone: row.client_telephone ? String(row.client_telephone).trim() : '',\n      prestation: (row.prestation || '').trim(),\n      prix_estime: parseFloat(row.prix_estime) || 0,\n      collaboratrice: (row.collaboratrice || 'Inconnue').trim(),\n      statut: (row.statut || 'confirmÃ©').trim(),\n      source_extraction: new Date().toISOString()\n    }\n  });\n}\n\nreturn items;"
      },
      "id": "transform-data",
      "name": "ğŸ”„ Normaliser donnÃ©es",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "jsCode": "// Collecte tous les id_unique du JSON entrant\n// et les stocke dans une variable globale accessible plus tard\nconst allIds = $input.all().map(item => item.json.id_unique);\n$execution.customData.set('ids_csv', JSON.stringify(allIds));\nreturn $input.all();"
      },
      "id": "store-ids",
      "name": "ğŸ’¾ MÃ©moriser IDs du CSV",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "id_unique|rich_text",
              "condition": "equals",
              "value": "={{ $json.id_unique }}"
            }
          ]
        }
      },
      "id": "notion-search",
      "name": "ğŸ” Chercher RDV dans Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-exists",
              "leftValue": "={{ $json.results?.length ?? 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-exists",
      "name": "â“ RDV existe dÃ©jÃ  ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "title": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.client_nom }} â€” {{ $('ğŸ”„ Normaliser donnÃ©es').item.json.prestation }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "id_unique|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.id_unique }}" },
            { "key": "Date|date", "date": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.date }}" },
            { "key": "Heure dÃ©but|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.heure_debut }}" },
            { "key": "Heure fin|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.heure_fin }}" },
            { "key": "DurÃ©e (min)|number", "numberValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.duree_minutes }}" },
            { "key": "Prestation|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.prestation }}" },
            { "key": "Collaboratrice|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.collaboratrice }}" },
            { "key": "Client|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.client_nom }}" },
            { "key": "TÃ©lÃ©phone|phone_number", "phoneValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.client_telephone }}" },
            { "key": "Prix estimÃ© (â‚¬)|number", "numberValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.prix_estime }}" },
            { "key": "Statut|select", "selectValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.statut }}" },
            { "key": "Source extraction|date", "date": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.source_extraction }}" }
          ]
        }
      },
      "id": "notion-create",
      "name": "âœ… CrÃ©er RDV dans Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1320, 180]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": "={{ $json.results[0].id }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "Statut|select", "selectValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.statut }}" },
            { "key": "Prix estimÃ© (â‚¬)|number", "numberValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.prix_estime }}" },
            { "key": "Heure dÃ©but|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.heure_debut }}" },
            { "key": "Heure fin|rich_text", "textValue": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.heure_fin }}" },
            { "key": "Source extraction|date", "date": "={{ $('ğŸ”„ Normaliser donnÃ©es').item.json.source_extraction }}" }
          ]
        }
      },
      "id": "notion-update",
      "name": "ğŸ” Mettre Ã  jour RDV Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1320, 420]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Statut|select",
              "condition": "does_not_equal",
              "value": "annulÃ©"
            },
            {
              "key": "Statut|select",
              "condition": "does_not_equal",
              "value": "no-show"
            },
            {
              "key": "Date|date",
              "condition": "on_or_after",
              "value": "={{ $now.toISO().split('T')[0] }}"
            }
          ]
        }
      },
      "id": "notion-get-all-active",
      "name": "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [440, 600]
    },
    {
      "parameters": {
        "jsCode": "// Compare les RDV en base Notion avec les IDs du JSON entrant\n// Si un RDV en base n'est PAS dans le JSON â†’ il a disparu â†’ AnnulÃ© ou No-show\n\nconst idsCSV = JSON.parse($execution.customData.get('ids_csv') || '[]');\nconst idsCSVSet = new Set(idsCSV);\n\nconst rdvAnnules = [];\n\nfor (const item of $input.all()) {\n  const page = item.json;\n  const idNotion = page.properties?.id_unique?.rich_text?.[0]?.plain_text || '';\n  const dateRDV = page.properties?.Date?.date?.start || '';\n  const now = new Date().toISOString().split('T')[0];\n\n  // Si l'ID n'est pas dans le JSON ET que la date est dans le futur ou aujourd'hui\n  if (idNotion && !idsCSVSet.has(idNotion) && dateRDV >= now) {\n    rdvAnnules.push({\n      json: {\n        page_id: page.id,\n        id_unique: idNotion,\n        date: dateRDV,\n        // Si la date est aujourd'hui â†’ No-show possible, sinon AnnulÃ©\n        nouveau_statut: dateRDV === now ? 'no-show' : 'annulÃ©',\n        detection_date: new Date().toISOString()\n      }\n    });\n  }\n}\n\nif (rdvAnnules.length === 0) {\n  return [{ json: { aucune_annulation: true } }];\n}\n\nreturn rdvAnnules;"
      },
      "id": "detect-cancelled",
      "name": "ğŸ” DÃ©tecter RDV disparus",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 600]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-no-cancel",
              "leftValue": "={{ $json.aucune_annulation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-no-cancel",
      "name": "â“ Des annulations ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 600]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": "={{ $json.page_id }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Statut|select",
              "selectValue": "={{ $json.nouveau_statut }}"
            }
          ]
        }
      },
      "id": "notion-mark-cancelled",
      "name": "ğŸš« Marquer AnnulÃ© / No-show",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1100, 520]
    },
    {
      "parameters": {
        "jsCode": "// RÃ©sumÃ© final de l'exÃ©cution\nconst idsCSV = JSON.parse($execution.customData.get('ids_csv') || '[]');\nreturn [{\n  json: {\n    message: 'âœ… Synchronisation Planity â†’ Notion terminÃ©e',\n    timestamp: new Date().toISOString(),\n    rdv_dans_json: idsCSV.length,\n    info: 'VÃ©rifiez Notion pour le dÃ©tail des crÃ©ations, mises Ã  jour et annulations'\n  }\n}];"
      },
      "id": "summary",
      "name": "ğŸ“Š RÃ©sumÃ© exÃ©cution",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 700]
    }
  ],
  "connections": {
    "ğŸŸ¢ DÃ©clencher manuellement": {
      "main": [
        [
          { "node": "ğŸ“‹ DonnÃ©es RDV (JSON)", "type": "main", "index": 0 },
          { "node": "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)", "type": "main", "index": 0 }
        ]
      ]
    },
    "ğŸ“‹ DonnÃ©es RDV (JSON)": {
      "main": [[{ "node": "ğŸ”„ Normaliser donnÃ©es", "type": "main", "index": 0 }]]
    },
    "ğŸ”„ Normaliser donnÃ©es": {
      "main": [[{ "node": "ğŸ’¾ MÃ©moriser IDs du CSV", "type": "main", "index": 0 }]]
    },
    "ğŸ’¾ MÃ©moriser IDs du CSV": {
      "main": [[{ "node": "ğŸ” Chercher RDV dans Notion", "type": "main", "index": 0 }]]
    },
    "ğŸ” Chercher RDV dans Notion": {
      "main": [[{ "node": "â“ RDV existe dÃ©jÃ  ?", "type": "main", "index": 0 }]]
    },
    "â“ RDV existe dÃ©jÃ  ?": {
      "main": [
        [{ "node": "âœ… CrÃ©er RDV dans Notion", "type": "main", "index": 0 }],
        [{ "node": "ğŸ” Mettre Ã  jour RDV Notion", "type": "main", "index": 0 }]
      ]
    },
    "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)": {
      "main": [[{ "node": "ğŸ” DÃ©tecter RDV disparus", "type": "main", "index": 0 }]]
    },
    "ğŸ” DÃ©tecter RDV disparus": {
      "main": [[{ "node": "â“ Des annulations ?", "type": "main", "index": 0 }]]
    },
    "â“ Des annulations ?": {
      "main": [
        [{ "node": "ğŸ“Š RÃ©sumÃ© exÃ©cution", "type": "main", "index": 0 }],
        [{ "node": "ğŸš« Marquer AnnulÃ© / No-show", "type": "main", "index": 0 }]
      ]
    },
    "ğŸš« Marquer AnnulÃ© / No-show": {
      "main": [[{ "node": "ğŸ“Š RÃ©sumÃ© exÃ©cution", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
