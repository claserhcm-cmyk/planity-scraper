{
  "name": "Planity â†’ Notion | Upsert RDV + DÃ©tection Annulations (JSON)",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger-manual",
      "name": "ğŸŸ¢ DÃ©clencher manuellement",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 300]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================\n// COLLE TON JSON ICI â€” tableau de RDV Planity\n// Champs attendus (correspond Ã  l'export CSV Planity) :\n//   \"Date du RDV\"  â†’ ex: \"15 fÃ©vrier 2026\"\n//   \"Statut\"       â†’ ex: \"HonorÃ©\", \"AnnulÃ©\", \"No-show\"\n//   \"Praticienne\"  â†’ ex: \"Sophie\"\n//   \"PrÃ©nom\"       â†’ ex: \"Marie\"\n//   \"Nom\"          â†’ ex: \"Dupont\"\n//   \"Heure dÃ©but\"  â†’ ex: \"09:00\"\n//   \"Heure fin\"    â†’ ex: \"10:00\"\n//   \"DurÃ©e (min)\"  â†’ ex: \"60\"\n//   \"TÃ©lÃ©phone\"    â†’ ex: \"0612345678\"\n//   \"Email\"        â†’ ex: \"marie@email.com\"\n//   \"Prestation\"   â†’ ex: \"Massage relaxant\"\n//   \"Prix (â‚¬)\"     â†’ ex: \"50\"\n//   \"Commentaire\"  â†’ ex: \"\"\n//   \"Jour (auto)\"  â†’ ex: \"Samedi\" (optionnel)\n// ============================================================\n\nconst rdvs = [\n  // â†“â†“â†“ REMPLACE CET EXEMPLE PAR TON JSON â†“â†“â†“\n  {\n    \"Date du RDV\": \"28 fÃ©vrier 2026\",\n    \"Statut\": \"HonorÃ©\",\n    \"Praticienne\": \"Sophie\",\n    \"PrÃ©nom\": \"Marie\",\n    \"Nom\": \"Dupont\",\n    \"Heure dÃ©but\": \"09:00\",\n    \"Heure fin\": \"10:00\",\n    \"DurÃ©e (min)\": \"60\",\n    \"TÃ©lÃ©phone\": \"0612345678\",\n    \"Email\": \"marie@email.com\",\n    \"Prestation\": \"Massage relaxant\",\n    \"Prix (â‚¬)\": \"50\",\n    \"Commentaire\": \"\",\n    \"Jour (auto)\": \"Samedi\"\n  }\n  // â†‘â†‘â†‘ FIN DE TON JSON â†‘â†‘â†‘\n];\n\nreturn rdvs.map(row => ({ json: row }));"
      },
      "id": "read-json",
      "name": "ğŸ“‹ DonnÃ©es RDV (JSON)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = [];\n\nconst mois = {\n  'janvier': '01', 'fÃ©vrier': '02', 'mars': '03', 'avril': '04',\n  'mai': '05', 'juin': '06', 'juillet': '07', 'aoÃ»t': '08',\n  'septembre': '09', 'octobre': '10', 'novembre': '11', 'dÃ©cembre': '12'\n};\n\nfor (const item of $input.all()) {\n  const row = item.json;\n  const statutRaw = (row['Statut'] || 'Ã€ confirmer').replace(/\\n/g, '').trim();\n\n  let dateISO = '';\n  const dateMatch = (row['Date du RDV'] || '').match(/(\\d+)\\s+(\\w+)\\s+(\\d{4})/);\n  if (dateMatch) {\n    const jour = dateMatch[1].padStart(2, '0');\n    const moisNum = mois[dateMatch[2].toLowerCase()] || '00';\n    const annee = dateMatch[3];\n    dateISO = `${annee}-${moisNum}-${jour}`;\n  }\n\n  const praticienne = (row['Praticienne'] || 'Inconnue').trim();\n  const clientNom = `${(row['PrÃ©nom'] || '').trim()} ${(row['Nom'] || '').trim()}`.trim();\n  const heureDebut = (row['Heure dÃ©but'] || '').trim();\n  const idUnique = `${dateISO}_${heureDebut}_${praticienne}_${clientNom}`.replace(/\\s+/g, '_');\n\n  items.push({\n    json: {\n      id_unique: idUnique,\n      date: dateISO,\n      jour: row['Jour (auto)'] || '',\n      heure_debut: heureDebut,\n      heure_fin: (row['Heure fin'] || '').trim(),\n      duree_minutes: parseInt(row['DurÃ©e (min)'] || 0),\n      client_prenom: (row['PrÃ©nom'] || '').trim(),\n      client_nom: (row['Nom'] || '').trim(),\n      client_telephone: (row['TÃ©lÃ©phone'] || '').trim(),\n      client_email: (row['Email'] || '').trim(),\n      prestation: (row['Prestation'] || '').trim(),\n      prix_estime: parseFloat((row['Prix (â‚¬)'] || '0').replace(',', '.')) || 0,\n      praticienne: praticienne,\n      statut: statutRaw,\n      commentaire: (row['Commentaire'] || '').replace(/\\n/g, '').trim(),\n      source_extraction: new Date().toISOString()\n    }\n  });\n}\n\nreturn items;"
      },
      "id": "transform-data",
      "name": "ğŸ”„ Transformer & GÃ©nÃ©rer ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "jsCode": "// Collecte tous les id_unique du JSON entrant\n// et les stocke dans une variable globale accessible plus tard\nconst allIds = $input.all().map(item => item.json.id_unique);\n$execution.customData.set('ids_csv', JSON.stringify(allIds));\nreturn $input.all();"
      },
      "id": "store-ids",
      "name": "ğŸ’¾ MÃ©moriser IDs du CSV",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "id_unique|rich_text",
              "condition": "equals",
              "value": "={{ $json.id_unique }}"
            }
          ]
        }
      },
      "id": "notion-search",
      "name": "ğŸ” Chercher RDV dans Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "check-exists",
              "leftValue": "={{ $json.results?.length ?? 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "if-exists",
      "name": "â“ RDV existe dÃ©jÃ  ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "create",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "title": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_prenom }} {{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_nom }} â€” {{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.prestation }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "id_unique|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.id_unique }}" },
            { "key": "Date|date", "date": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.date }}" },
            { "key": "Heure dÃ©but|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.heure_debut }}" },
            { "key": "Heure fin|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.heure_fin }}" },
            { "key": "DurÃ©e (min)|number", "numberValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.duree_minutes }}" },
            { "key": "Prestation|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.prestation }}" },
            { "key": "Praticienne|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.praticienne }}" },
            { "key": "Client nom|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_nom }}" },
            { "key": "Client prÃ©nom|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_prenom }}" },
            { "key": "TÃ©lÃ©phone|phone_number", "phoneValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_telephone }}" },
            { "key": "Email|email", "emailValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.client_email }}" },
            { "key": "Prix estimÃ© (â‚¬)|number", "numberValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.prix_estime }}" },
            { "key": "Statut|select", "selectValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.statut }}" },
            { "key": "Commentaire|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.commentaire }}" },
            { "key": "Source extraction|date", "date": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.source_extraction }}" }
          ]
        }
      },
      "id": "notion-create",
      "name": "âœ… CrÃ©er RDV dans Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1320, 180]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": "={{ $json.results[0].id }}",
        "propertiesUi": {
          "propertyValues": [
            { "key": "Statut|select", "selectValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.statut }}" },
            { "key": "Prix estimÃ© (â‚¬)|number", "numberValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.prix_estime }}" },
            { "key": "Heure dÃ©but|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.heure_debut }}" },
            { "key": "Heure fin|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.heure_fin }}" },
            { "key": "Commentaire|rich_text", "textValue": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.commentaire }}" },
            { "key": "Source extraction|date", "date": "={{ $('ğŸ”„ Transformer & GÃ©nÃ©rer ID').item.json.source_extraction }}" }
          ]
        }
      },
      "id": "notion-update",
      "name": "ğŸ” Mettre Ã  jour RDV Notion",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1320, 420]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": "TON_DATABASE_ID_NOTION_ICI",
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Statut|select",
              "condition": "does_not_equal",
              "value": "AnnulÃ©"
            },
            {
              "key": "Statut|select",
              "condition": "does_not_equal",
              "value": "No-show"
            },
            {
              "key": "Date|date",
              "condition": "on_or_after",
              "value": "={{ $now.toISO().split('T')[0] }}"
            }
          ]
        }
      },
      "id": "notion-get-all-active",
      "name": "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [440, 600],
      "notes": "RÃ©cupÃ¨re tous les RDV futurs non annulÃ©s dÃ©jÃ  en base"
    },
    {
      "parameters": {
        "jsCode": "// Compare les RDV en base Notion avec les IDs du JSON entrant\n// Si un RDV en base n'est PAS dans le JSON â†’ il a disparu â†’ AnnulÃ© ou No-show\n\nconst idsCSV = JSON.parse($execution.customData.get('ids_csv') || '[]');\nconst idsCSVSet = new Set(idsCSV);\n\nconst rdvAnnules = [];\n\nfor (const item of $input.all()) {\n  const page = item.json;\n  const idNotion = page.properties?.id_unique?.rich_text?.[0]?.plain_text || '';\n  const dateRDV = page.properties?.Date?.date?.start || '';\n  const now = new Date().toISOString().split('T')[0];\n\n  // Si l'ID n'est pas dans le JSON ET que la date est dans le futur ou aujourd'hui\n  if (idNotion && !idsCSVSet.has(idNotion) && dateRDV >= now) {\n    rdvAnnules.push({\n      json: {\n        page_id: page.id,\n        id_unique: idNotion,\n        date: dateRDV,\n        // Si la date est aujourd'hui â†’ No-show possible, sinon AnnulÃ©\n        nouveau_statut: dateRDV === now ? 'No-show' : 'AnnulÃ©',\n        detection_date: new Date().toISOString()\n      }\n    });\n  }\n}\n\nif (rdvAnnules.length === 0) {\n  // Rien Ã  annuler, on retourne un item vide pour ne pas bloquer le workflow\n  return [{ json: { aucune_annulation: true } }];\n}\n\nreturn rdvAnnules;"
      },
      "id": "detect-cancelled",
      "name": "ğŸ” DÃ©tecter RDV disparus",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 600]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "leftValue": "={{ $json.aucune_annulation }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "if-no-cancel",
      "name": "â“ Des annulations ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 600]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": "={{ $json.page_id }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Statut|select",
              "selectValue": "={{ $json.nouveau_statut }}"
            },
            {
              "key": "Commentaire|rich_text",
              "textValue": "=DÃ©tectÃ© comme {{ $json.nouveau_statut }} le {{ $json.detection_date }}"
            }
          ]
        }
      },
      "id": "notion-mark-cancelled",
      "name": "ğŸš« Marquer AnnulÃ© / No-show",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [1100, 520]
    },
    {
      "parameters": {
        "jsCode": "// RÃ©sumÃ© final de l'exÃ©cution\nconst idsCSV = JSON.parse($execution.customData.get('ids_csv') || '[]');\nreturn [{\n  json: {\n    message: 'âœ… Synchronisation Planity â†’ Notion terminÃ©e',\n    timestamp: new Date().toISOString(),\n    rdv_dans_json: idsCSV.length,\n    info: 'VÃ©rifiez Notion pour le dÃ©tail des crÃ©ations, mises Ã  jour et annulations'\n  }\n}];"
      },
      "id": "summary",
      "name": "ğŸ“Š RÃ©sumÃ© exÃ©cution",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 700]
    }
  ],
  "connections": {
    "ğŸŸ¢ DÃ©clencher manuellement": {
      "main": [
        [
          { "node": "ğŸ“‹ DonnÃ©es RDV (JSON)", "type": "main", "index": 0 },
          { "node": "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)", "type": "main", "index": 0 }
        ]
      ]
    },
    "ğŸ“‹ DonnÃ©es RDV (JSON)": {
      "main": [[{ "node": "ğŸ”„ Transformer & GÃ©nÃ©rer ID", "type": "main", "index": 0 }]]
    },
    "ğŸ”„ Transformer & GÃ©nÃ©rer ID": {
      "main": [[{ "node": "ğŸ’¾ MÃ©moriser IDs du CSV", "type": "main", "index": 0 }]]
    },
    "ğŸ’¾ MÃ©moriser IDs du CSV": {
      "main": [[{ "node": "ğŸ” Chercher RDV dans Notion", "type": "main", "index": 0 }]]
    },
    "ğŸ” Chercher RDV dans Notion": {
      "main": [[{ "node": "â“ RDV existe dÃ©jÃ  ?", "type": "main", "index": 0 }]]
    },
    "â“ RDV existe dÃ©jÃ  ?": {
      "main": [
        [{ "node": "âœ… CrÃ©er RDV dans Notion", "type": "main", "index": 0 }],
        [{ "node": "ğŸ” Mettre Ã  jour RDV Notion", "type": "main", "index": 0 }]
      ]
    },
    "ğŸ“‹ RÃ©cupÃ©rer RDV actifs Notion (futurs)": {
      "main": [[{ "node": "ğŸ” DÃ©tecter RDV disparus", "type": "main", "index": 0 }]]
    },
    "ğŸ” DÃ©tecter RDV disparus": {
      "main": [[{ "node": "â“ Des annulations ?", "type": "main", "index": 0 }]]
    },
    "â“ Des annulations ?": {
      "main": [
        [{ "node": "ğŸ“Š RÃ©sumÃ© exÃ©cution", "type": "main", "index": 0 }],
        [{ "node": "ğŸš« Marquer AnnulÃ© / No-show", "type": "main", "index": 0 }]
      ]
    },
    "ğŸš« Marquer AnnulÃ© / No-show": {
      "main": [[{ "node": "ğŸ“Š RÃ©sumÃ© exÃ©cution", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
